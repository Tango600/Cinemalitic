Declare=PrintFDQuery;
SetValue=PrintFDQuery=select FD.delivery_num, c.agreement_date, coalesce(BD.SHORT_NAME, T.CINEMA_NAME || ' *') || ' г.' || cy.CITY_NAME CINEMA_NAME, '"' || F.FILM_NAME || '"' || cast(', ' || (select list(c.country_name, ';') from countries_to_films cf left join countries c on cf.country_id = c.contr_id where cf.film_id = f.id_film) || ', ' as varchar(300)) || coalesce(F.relice_year || 'г.', '') FILM_NAME, coalesce('с ' || DATE2STR(fc.roll_date_begin) || ' по ', '') || coalesce(DATE2STR(fc.roll_date_end), '') roll_dates, mt.media_name from FILMS_TO_CONTRACTS FC left join FILMS F on FC.FILM_ID = F.ID_FILM left join FILMS_DELIVERYS FD on FC.CONTRACT_ID = FD.CONTRACT_ID and FC.FILM_ID = FD.FILM_ID left join CONTRACTS C on C.contract_id = fd.contract_id left join theaters t on c.cinema_id = t.cinema_id left join cityes cy on t.city_id = cy.cty_id left join media_type mt on c.media_type_id = mt.med_id left join (select first 1 bd1.short_name, bd1.partner_id from bank_details bd1 where bd1.is_delete = 0 order by bd1.is_default desc) bd on c.cinema_id = bd.partner_id where fd.film_id is not null;